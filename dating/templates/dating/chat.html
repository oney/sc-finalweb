{% extends 'dating/base.html' %}
{% load static %}
{% block title %}home{% endblock %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}" />
{% endblock %}
{% block content %}
<div class="container">
  <h1>Chat with <a href="{% url 'user' id=user.id %}">{{ user.name }}</a></h1>
  <div class="room-outer">
    <ul class="list-group" id="room">
      {% for message in messages %}
        <li class="list-group-item {% if message.user_id == request.session.user_id %}me{% else %}other{% endif %}">
          {% if message.user_id != request.session.user_id %}
            {{ message.user.name }}:
          {% endif %}
          {{ message.content }}
        </li>
      {% endfor %}
    </ul>
  </div>
  <input type="text" class="form-control" id="input" placeholder="Type messages...">
</div>
<script type="text/javascript">
var room = document.getElementById("room");
var input = document.getElementById("input");
var meId = {{ me.id }};
room.scrollIntoView(false);

function addMessage(content, user) {
  var li = document.createElement("li");
  li.classList = "list-group-item " + (user === undefined ? "me" : "other");
  li.appendChild(document.createTextNode((user ? user + ": " : "") + content)); 
  room.appendChild(li);

  room.scrollIntoView(false);
}

var ws;
function connect() {
  ws = new WebSocket('ws://' + window.location.host + '/ws/chat/{{ room.id }}/?token={{ jwt_token }}');

  ws.onmessage = function (e) {
    var data = JSON.parse(e.data);
    var message = data.message;
    if (meId == message.user.id) return;

    addMessage(message.content, message.user.name);
  };

  ws.onclose = function (e) {
    console.error('Chat socket closed unexpectedly');
    setTimeout(function() {
      connect();
    }, 500);
  };

  ws.onerror = function(err) {
    console.error('Socket encountered error: ', err.message, 'Closing socket');
    ws.close();
  };
}

connect();

input.onkeyup = function(event) {
  if (ws.readyState != 1) {
    alert("Connecting to chat server...\nTry later");
    return;
  }

  if (event.keyCode === 13 && input.value) {
    addMessage(input.value);
    ws.send(JSON.stringify({
      'content': input.value
    }));
    input.value = "";
  }
}
</script>
{% endblock %}
